<!doctype html>

<html lang="fr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/themes/prism.min.css" integrity="sha256-77qGXu2p8NpfcBpTjw4jsMeQnz0vyh74f5do0cWjQ/Q=" crossorigin="anonymous" />

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  
  <title>TP1 : ESXi </title>
  
  <meta name="description" content="Cluster">
  <meta name="author" content="Jean-Marc Menaud">
</head>


<body>

<div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapse2"></font color=red  size=5> L'architecture matérielle et logicielle </font> </a>
      </h4>
    </div>
    <div id="collapse2" class="panel-collapse collapse">
      <div class="panel-body">
		<p> Nous avons acheté des mini-machines avec un processeur intel i7 et 64Go de Ram.
		Sur ces min-machines (NUC) nous avons installer un ESXi. Cet ESXi et nommé pESX (p = physical).
		Nous avons actuellement 12 machines de ce type, donc de pESX01 à pESX12. </p>
		<p> Nous avons démarré plusieurs VM sur ces pESX ou sont installés des ESXi. 
		ces ESXi s'exécutent virtuellement dans une VM, nous les avons appelés vESX.
		Le nombre de vESX dépend du nombre d'étudiant mais nous pouvons créer jusqu'à 150 vESX. 
		Dans l'exemple donné, nous avons 2 vESX (vESX001 et vESX002) qui s'exécutent sur le pESX01 </p>
		<p> Vous allez démarrer des VM qui vont s'exécuter sur un vESX. Ici trois VM Linux s'exécutent sur le vESX001 et 2 sur le vESX002</p>
		
	    <a href="http://menaud.fr/Cours/Cloud/Subjects/images/Matos1.png">
         <img alt="Matos1" src="http://menaud.fr/Cours/Cloud/Subjects/images/Matos1.png"
         width=150" height="70">
      	</a>
      	<br>
      	<p> Les NUC sont connectés entre eux via un switch réseau classique de 1 Gb/s.
      	Dans l'exemple ci après, nous retrouvons les 2 vESX (vESX001 et vESX002) qui s'exécutent sur le pESX01 
      	et deux autres vESX (vESX003 et vESX004) qui s'exécutent sur le pESX02</p>
      	    <a href="http://menaud.fr/Cours/Cloud/Subjects/images/Matos2.png">
         <img alt="Matos1" src="http://menaud.fr/Cours/Cloud/Subjects/images/Matos2.png"
         width=150" height="70">
      	</a>
      	 <br>
		<p>Vous pouvez vous connecter a vos vESX en tapant direcment l'URL dans un navigateur. Nous avons acheté le nom de dommaine cumulus.ovh pour plus de facilité d'accès</p>
      		    <a href="http://menaud.fr/Cours/Cloud/Subjects/images/Matos3.png">
         <img alt="Matos1" src="http://menaud.fr/Cours/Cloud/Subjects/images/Matos3.png"
         width=150" height="70">
      	</a>
      	<p> ou y accéder par ssh </p>
      		    <a href="http://menaud.fr/Cours/Cloud/Subjects/images/Matos4.png">
         <img alt="Matos1" src="http://menaud.fr/Cours/Cloud/Subjects/images/Matos4.png"
         width=150" height="70">
      	</a>
      	<p>
      	<b>Nouveauté 2021 !</b>
      	La configuration pour cette année a légèrement changé, l'ensemble de pESX est hébergé à l'école. Vous pouvez donc y accéder directement en tapant l'IP.
      	Pour le SSH, de même, plus besoin de passer par le port 22100. un ssh directement sur le port 22 fonctionne.
      	</p>
      </div>

    </div>
  </div>
</div>


<!--

<div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapse1"></font color=red  size=5> Informations générales pour réaliser le TP </font> </a>
      </h4>
    </div>
    
    <div id="collapse1" class="panel-collapse collapse">
      <div class="panel-body">

<div class="alert alert-success" role="alert">
Find on <a href="https://lite.framacalc.org/rawguzpu4l-a0gz">this link</a> your student number.
</div>


 <table border=2  cellpadding="1" cellspacing="1">
		<tr>
		  <td>-------- Nom -------- </td>
		  <td>-------- URL --------</td>
		  <td>-- SSH port -- </td>
		  <td>-- pESXi --</td>
		  <td>-- VPN Access --</td>
		</tr>
		<tr>
			<tr><td>Student 1 </td><td><a href="https://10.144.208.101/" target="_blank"> 10.144.208.1<i style="color:red;">01</i> </a></td><td>22</td><td>15</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest01.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 11</td><td><a href="https://10.144.208.102/" target="_blank">10.144.208.1<i style="color:red;">02</i></a></td><td>...</td><td>15</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest11.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 21</td><td><a href="https://10.144.208.103/" target="_blank">10.144.208.103</a></td><td>...</td><td>15</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest21.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 2 </td><td><a href="https://10.144.208.104/" target="_blank">10.144.208.104</a></td><td>...</td><td>15</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest02.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 12</td><td><a href="https://10.144.208.105/" target="_blank">10.144.208.105</a></td><td>...</td><td>15</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest12.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 22</td><td><a href="https://10.144.208.106/" target="_blank">10.144.208.106</a></td><td>...</td><td>15</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest22.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 3 </td><td><a href="https://10.144.208.107/" target="_blank">10.144.208.107</a></td><td>...</td><td>16</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest03.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 13</td><td><a href="https://10.144.208.108/" target="_blank">10.144.208.108</a></td><td>...</td><td>16</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest13.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 23</td><td><a href="https://10.144.208.109/" target="_blank">10.144.208.109</a></td><td>...</td><td>16</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest23.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 4 </td><td><a href="https://10.144.208.110/" target="_blank">10.144.208.110</a></td><td>...</td><td>16</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest04.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 14</td><td><a href="https://10.144.208.111/" target="_blank">10.144.208.111</a></td><td>...</td><td>16</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest14.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 24</td><td><a href="https://10.144.208.112/" target="_blank">10.144.208.112</a></td><td>...</td><td>16</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest24.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 5 </td><td><a href="https://10.144.208.113/" target="_blank">10.144.208.113</a></td><td>...</td><td>17</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest05.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 15</td><td><a href="https://10.144.208.114/" target="_blank">10.144.208.114</a></td><td>...</td><td>17</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest15.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 25</td><td><a href="https://10.144.208.115/" target="_blank">10.144.208.115</a></td><td>...</td><td>17</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest25.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 6 </td><td><a href="https://10.144.208.116/" target="_blank">10.144.208.116</a></td><td>...</td><td>17</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest06.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 16</td><td><a href="https://10.144.208.117/" target="_blank">10.144.208.117</a></td><td>...</td><td>17</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest16.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 26</td><td><a href="https://10.144.208.118/" target="_blank">10.144.208.118</a></td><td>...</td><td>17</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest26.conf" target="_blank"> guest0X.conf</a></td></tr>
			<tr><td>Student 7 </td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.119</a></td><td>...</td><td>18</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest07.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 17</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.120</a></td><td>...</td><td>18</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest17.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 27</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.121</a></td><td>...</td><td>18</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest27.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 8 </td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.122</a></td><td>...</td><td>18</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest08.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 18</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.123</a></td><td>...</td><td>18</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest18.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 28</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.124</a></td><td>...</td><td>18</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest28.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 9 </td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.125</a></td><td>...</td><td>20</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest09.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 19</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.126</a></td><td>...</td><td>20</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest19.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 29</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.127</a></td><td>...</td><td>20</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest29.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 10</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.128</a></td><td>...</td><td>20</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest10.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 20</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.129</a></td><td>...</td><td>20</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest20.conf" target="_blank"> guest0X.conf</a></td></tr>	
			<tr><td>Student 30</td><td><a href="https://10.144.208.119/" target="_blank">10.144.208.130</a></td><td>...</td><td>20</td><td><a href="http://www.menaud.fr/Cours/Cloud/TP/ConfRes/guest30.conf" target="_blank"> guest0X.conf</a></td></tr>	
	</table>
	
</div>

<div class="panel-footer">Salons discord: https://discord.gg/4VZMMDu<br>
</div>

<div class="card" style="width: 50rem;">
   <h5 class="card-header">
    Login
  </h5>
  <ul class="list-group list-group-flush">
    <li class="list-group-item">root</li>
    <li class="list-group-item">toto32**</li>
  </ul>
</div>


<div class="card" style="width: 50rem;">
  <div class="card-header">
    Only for IMT Atlantique Students !
  </div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item">To connect from outside, generate your  <a href="https://eduvpn.imt-atlantique.fr/vpn-user-portal/" target="_blank"> VPN access </a></li>
    <li class="list-group-item">You can use this <a href="https://openvpn.net/vpn-client/" target="_blank"> VPN Client </a></li>
  </ul>
</div>

<div class="card" style="width: 50rem;">
  <div class="card-header">
    Only for External Students !
  </div>
  <ul class="list-group list-group-flush">
    <li class="list-group-item">Download your VPN access </li>
    <li class="list-group-item">Add configuration to WireGuard</li>
  </ul>
</div>


	<div>
		If needed, to update the ESXi licence : connect you on our vesxi by ssh then execute :<br>
		<code>cp /etc/vmware/.#license.cfg /etc/vmware/license.cfg</code><br>
		<code>/etc/init.d/vpxa restart</code><br>
	</div>
    </div>
    
    
  </div>
</div>
-->
<div class="panel-group">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" href="#collapse3"></font color=red  size=5> Servers affectation</font> </a>
      </h4>
    </div>
    
    <div id="collapse3" class="panel-collapse collapse">
      	<div class="panel-body">

			
			<!--#include virtual="affectation.html"-->
			
		</div>
	</div>
    
    
  </div>
</div>




  <div class="container">
  <h1>ESX</h1>
  	<p>
	First practical session on your hypervisor in charge of running virtual machine.
	</p>

  <!-- PARTIE 1 -->
  <div class="border-top">
  
	<h2> 1. Graphical Unit Interface (GUI) </h2> <HR size=2 align=center width="100%">		

	<h3>1.1 Your vESXi</h3>
	
	<h4>1.1.1 Try to connect on your vESX. <span class="badge badge-secondary">5 minutes</span></h4>
	Try to connect on your vESX. user : root - Password :  toto32**

 
		  
		<h4>1.1.2 Your vESX is connected by Bridge, Nat or Host Only on the pESXi ? <span class="badge badge-secondary">15 minutes</span></h4>
	  		  <p>Search on google and understand the difference between Bridge, Nat and Host Only.</p>
	  		  
		<h3>1.2 vESX GUI </h3>
		
		<center><img src='images/PS0/Vesx.png' width="900px"></center>
		
		<h4>1.2.1 Play with the GUI <span class="badge badge-secondary">5 minutes</span></h4>
		<p> More precisely, inspect the three main corposants: host, switch, datastore. 			
		</p>
		<p>
		Find your IP.
		</p>

		<h4>1.2.2  Create and Play with your tinyVM <span class="badge badge-secondary">25 minutes</span></h4>
		<p> Now, we are ready to start our first VM. First, download and install a simple OVA. 
		File can be found <a href="http://menaud.fr/Cours/Cloud/TP/PS1/OVA-Linux/tinyVM.ova">here</a>				
		</p>
		<p> Name your VM : tinyVMXX where XX is your StudentNumber !</p>
		<p>Thick Provisioning and Thin Provisioning ? understand the difference </p>
		<p> In your vESX you have 2 disks, create this VM on the vDatastoreXXX_YYY</p>
		<p>
		Find the tinyVM's IP. 		
		</p>
		<p> Start, stop, suspend, restart your first VM. Explore the datastore, list all files required by this Linux VM.	
		</p>
		<p>
		This tinyVM was configured with 128 Mb, it’s not sufficient for a correct execution, change this value to 164 Mb.			
		</p>
		
		<h4>1.2.3 SSH vESX <span class="badge badge-secondary">5 minutes</span></h4>
		
		<p> Activate (if not) on the vESX the SSH server (with the GUI) </p>
		<p>Connect with the root user by SSH on your vESX on the port</p>
		<p> For windows users : download and use putty.exe. <a href="http://menaud.fr/Cours/Cloud/TP/PS2/SSH-Windows/putty-64bit-0.70-installer.msi">here</a>				
		</p>	
		<p>or open a powershell terminal</p>		
		<p>On Linux ou Mac :</p>
		<p>ssh -p 22 root@vesx<i style="color:red;">number</i>.cumulus.ovh </p>
	
		<h4>1.2.4 SSH on your tinyVM <span class="badge badge-secondary">5 minutes</span></h4>
		<p> You can connect directly to the VM by ssh :  username: tc  
		password: toto32**			</p>
		
		<p> If the connection don't work, you need to activate (enable) the ssh client port on your vesx firewall (Networking -> Firewall -> Select SSH Client -> Click on “Enable”)</p>

		<h3>1.2.5 CPU </h3>
		The stress.tcz package was intalled on your tinyVM.
				 Install it:<code> tce-load -i stress
		</code>

		 <p> stress your tinyVM and observe the activity cpu graph</p>
		 <p>when you stress 2 CPU <code>stress -c 2</code> , only on CPU are stressed in the graph (Hote->Surveiller). Why ?</p>
		 
		 <p>Connect you by ssh on your vESXi</p>
		 <code>TERM=xterm</code><br>
		 <code>esxtop</code><br>
		 <p>explain %RDY</p>
		 
		<h3>1.3 Network </h3>
		<h4>DHCP</h4>
		<p>Your vESX have a dynamique IP. Run dcui (the adminstration concol) fromm ssh and find the IP of the DHCP server</p>
		
		<h4>1.3.1 Understand how your VM is connected with yours neighbors <span class="badge badge-secondary">25 minutes</span></h4>
		
		<p> If you use the web console. Be careful, the default keyboard is a "qwerty", change it.</p>		
		<center><img src='images/PS1/Keyboard.png' width="500px"></center>
		
		<!-- <p> Install iperf in your tinylinux</p>
		Install a proxy : <code> export http_proxy="http://kgb.emn.fr:3128" </code>
		 <br/>
		-->
		
		<!--Download the package: <code>	
		wget http://www.menaud.fr/tools/iperf.tcz </code>
		 <br/>-->
		<!--  
		 <p> If the proxy don't work, download on your laptop iperf.tcz then 
		 	<code>scp -r -p iperf.tcz tc@IPtinyVM:/home/tc/iperf.tcz</code>
		 </p>
		 <p> For windows, you can use : http://www.menaud.fr/tools/WinSCP-5.19.5-Setup.exe </p>
		-->  	
		Install the package:<code> tce-load -i iperf
		</code>
		<!-- Alternative: wget http://www.tinycorelinux.net/4.x/x86/tcz/iperf.tcz <br/> -->
		
		<p> Read the <a href="https://openmaniak.com/fr/iperf.php" target="_blank">documentation</a> and start the iperf server <code> iperf -s &amp; </code></p> </p>

		<p>In the top of this page you can find the pESX number hosting (running) your vESX</p>
		
		<ol>
		<li>First use iperf in your local VM IP and save your network throughput. Connect twice to your 'tinyVM.' In the first terminal, start the server, and in the second one, run the client </li>
		<li> Create a second 'tinyVM' on vDatastoreXXX_YYY and name it 'tinyVMServerZZ, where ZZ is your student number. Start iperf serveur inside. Test the throughput between your tinyVM and your tinyVMServer </li>
		<li> Next, use iperf client with a distant VM on the same server (pESX). Find a vESX running on your pESX (check the server assignment table), note its number (N). Test your iperf client on tinyServerN</li>
		<li>Finaly, use iperf client with a distant VM on a different server (pESX) and save the network throughput. Find a vESX don't running on your pESX (check the server assignment table), note its number (V). Test your iperf client on tinyServerV</li>
		<a href="http://menaud.fr/Cours/Cloud/Subjects/images/Rez.png">
         <img alt="Matos1" src="http://menaud.fr/Cours/Cloud/Subjects/images/Rez.png"
         width=400" height="250">
      	</a>
      	</ol>

      	</ul>		
		<br>
		<li>Save yours (4) results in this calc : <a href="https://lite.framacalc.org/9k5p-debit-entre-vm" target="_blank">file</a> 	</li>
		<li> abscisse : ESX send data. Ordonnée : ESX receive data</li>
		<ul>
			<li>vesxnumber -> vesxnumber : 40Gb/s (max, generally 40Gb/s)</li>
			<li>vesxnumber -> vesxnumber (on same pESX) : 10Gb/s (max, generally 1Gb/s)</li>
			<li>vesxnumber -> vesxnumber (on different pESX) : 1Gb/s (max, generally 500Mb/s)</li>
		</ul>

		<li>Concluded.</li>
		
		</ul>

		<h4>1.3.2  vswitch <span class="badge badge-secondary">10 minutes</span></h4>
		Configure your vswitch (Vswitch0) with a limited bandwith (100mo). <br>
		Retry iperf to evaluate the bandwith.<br>
      	<i style="color:red;">Change your vswitch (Vswitch0) to 1Go/s.</i>	 <br>

      	<h3>1.4 VM advanced</h3>
      	<h3>1.4.1 Migration</h3>
      	Create a tinyVM named tinyVMmigXX (XX = student number) on vsanDatastoreXX.
		We will now migrate our virtual machine from one server to another. First, suspend your virtual machine.<br>
		The in-memory data of your VM has been stored in a file located in the VM's directory on the vSanDataStore. Find this file <br>
		When you resume your VM, this file is read and loaded into memory, and then execution is resumed.<br>
		We will resume the VM on another server. The vSanDataStore is shared among multiple vESXi hosts<br>
		Find another server that shares your vSanDatastore (check the server assignment section)<br>
		Connect to this server and resume your VM<br>
		You have just successfully migrated your first VM!<br>
		

		<h3>1.4.2 Snapshot</h3>
		Create a restore a snapshot of your tinyVM <a href="https://www.informatiweb-pro.net/virtualisation/vmware/vmware-esxi-6-7-creer-des-instantanes-d-une-machine.html">read this</a>
		<p>From IHM, open the tiyVM console, create the directory "TOTO". Create a snapshot 1. Then on the console create "TUTU".</p>
		<p>Restore the VM state before the creation of the directory TUTU</p>


      	<h3>1.5 VM creation</h3>

		<h4>1.4.1  New VM from scratch <span class="badge badge-secondary">10 minutes</span></h4>
		<p>Finally, Install a new VM Linux from scratch throught UI. Download the Iso file and install, start and ping the Linux Core 5.4. 
		File can be found <a href="http://menaud.fr/Cours/Cloud/TP/PS1/ISOLinux/Core-5.4.iso">here</a>
		OS:Linux 32b ; RAM : 64Mb ; Disk : 20Mb					
		</p>

		
</div> <!-- fin de <div class="border-top"> --> 
  <!-- FIN DE PARTIE 1 -->
 
  <!-- PARTIE 2 -->
  <div class="border-top">
   	
	<h2 > 2 Around the command line </h2> <HR size=2 align=center width="100%">		

	<p> All this practical session will be realize 
	from SSH and command line. You can use esxcli commands and vim-cmd. 
	First, read these tutorials :	
	<a href="http://www.menaud.fr/Cours/Cloud/Subjects/PS1-ESXCLI.html">esxcli</a>	
	and <a href="http://www.menaud.fr/Cours/Cloud/Subjects/DocPS1/Quick.pdf">vim-cmd</a>	<br>
	A command list can be found <a href="http://www.menaud.fr/Cours/Cloud/Subjects/DocPS1/cmd-esxi.html">here</a>
	or <a href="https://wiki.maxcorp.org/listes-des-commandes-utiles-sous-esx-esxi-terminal/">here</a>
	</p>
	
	<h3>2.1 First command </h3>
	<h4>2.1.1 SSH on vESX (as previously) <span class="badge badge-secondary">5 minutes</span></h4>
	<p> Activate (if not) on the vESX the SSH server (with the GUI) </p>
	<p>Connect by SSH on your vESX </p>
	
	<h4>2.1.2 From command line, reboot  your ESXi <span class="badge badge-secondary">5 minutes</span></h4>
	<p> Don’t forget to change your esx state to maintenance mode				</p>			

	<h4>2.1.3 Around VM life cycle <span class="badge badge-secondary">25 minutes</span></h4>
	<p>Find the correct command line to list all VM on your ESXi </p>
	<p> Note on a paper all VM VMWare ID.				</p>			

	<p> Start, Stop VM from the command line </p>
	<p>Unregister a VM. Verify from GUI that the VM is no visible.</p>
	<p>Register the VM previously unregister. What’s happen with the VMWare ID.</p>
	
	<h4>2.1.4 Snapshot <span class="badge badge-secondary">10 minutes</span></h4>
	
	https://vuptime.io/post/2015-02-26-play-vm-snapshots-esxi-command-line-tools/
	
	<p> Same question before but we the command line. Create an restart from a snapshot a VM</p>
	<code>vmsvc/snapshot.get vmid</code>
	<code>vim-cmd vmsvc/snapshot.create vmid "titi" </code>
	<code>vim-cmd vmsvc/snapshot.create vmid "toto" </code>
	<p>revert to a previous snapshot</p>
	<code>vim-cmd vmsvc/snapshot.revert 1 4 0</code>
		
	<h4>2.1.5 Create VM <span class="badge badge-secondary">10 minutes</span></h4>

	<p> Create a new VM (same name, same UUID), by command line, from files associated to the yVM. (You must modify the VM file configuration)		</p>
	
		<ul> 		
				<li>		Find the command line for list the main properties of a VM. What is the UUID ?		</li>				
				<li>		Try to start 2 VM with same name and same UUID (by directly modified the		VM file configuration. Don’t forget to reload the configuration)		</li>	
		</ul>

	<h4>2.1.4 Around users <span class="badge badge-secondary">10 minutes</span></h4>

	<p> Create and manage a new user for your hypervisor. Restrict to ReadOnly his permissions.		</p>  
	
	
</div> <!-- fin de <div class="border-top"> --> 
  <!-- FIN DE PARTIE 2 -->

  <!-- PARTIE 3 -->
  <div class="border-top">
  
 	<h3>2.2 Advanced command </h3>

	<HR size=2 align=center width="100%">	
	
	<h4>2.2.1 VM from scratch <span class="badge badge-secondary">15 minutes</span></h4>

	<p> Download from command line the iso file :			
		<ul>		  		
		<li> wget http://www.menaud.fr/tools/Core-5.4.iso				</li>		  		
		<li> For that you need to add a DNS server (from command line) in your ESXi.				</li>			
		</ul>		
	</p>		
	
	<p> Created the VM folder (Core), created the virtual hard disk for the VM with the command - vmkfstools (5Gb, lsilogic) (Core.vmdk).		</p>		
	<p> Created a VMX file with the following text, change ??? by the correct value :	</p>	
	<div style="padding:3px; border:2px dotted #a5a5a5; background-color:#e3e3e3;">		
	config.version = "8" <br>		
	virtualHW.version= "7" <br>		
	guestOS = " ???" <br>		
	memsize = "1024" <br>		
	displayname = "???" <br>		
	scsi0.present = "TRUE" <br>		
	scsi0.virtualDev = "lsilogic" <br>		
	scsi0:0.present = "TRUE" <br>		
	scsi0:0.fileName = "Core.vmdk" <br>		
	ide1:0.present = "true" <br>		
	ide1:0.deviceType = "cdrom-image" <br>		
	ide1:0.filename = " ??" <br>		
	ide1:0.startConnected = "TRUE" <br>		
	ethernet0.present= "true" <br>		
	ethernet0.startConnected = "true" <br>		
	ethernet0.virtualDev = "e1000"<br>		
	</div>		
	</li>
	<p> For reload the VMX, you need use : vim-cmd vmsvc/reload Vmid</p>
	<p> Changed the permissions on the VMX file with chmod 744 Core.vmx.		</p>
	
	<p> Add to the inventory the VM (register the VM) and power on the VM		</p>
	
	<p> At this point the VM was up and running and the last thing to do was to disconnect the CD-ROM in the VM		</p>
	
	<h4>2.2.2 VM network <span class="badge badge-secondary">15 minutes</span></h4>

	<p> At this point we went to check IP connectivity and noticed the VM did not have an IP address. You can verified this with :			
		<ul>				
		<li> vim-cmd vmsvc/get.summary X				</li>			
		</ul>		
	</p>				
	
	<p>		Edited the VMX file and added completed the below line.			
		<ul>				
		<li> ethernet0.networkName = " ???"				</li>			
		</ul>		
	</p>				
	
	<p> Reloaded the VMX file (vim-cmd vmsvc/reload X), Verified that ESXi saw the configuration change made.		</p>	
	
	<p> Set the virtual NIC to a status of connected. 
	The device.connection option requires the VMID, 
	the deviceKey and connect setting. 
	Connect can be set to 1 (connected) or 0 (disconnected). 
	The deviceKey can be found from the output device.getdevices. 
	As shown above in bold, the deviceKey for the vnic for this VM is 4000. 
	Once the command was run the vnic in the VM connected and wasable to get an IP address from a DHCP server.		
	
	<div style="padding:3px; border:2px dotted #a5a5a5; background-color:#e3e3e3;">		
	~ # vim-cmd vmsvc/device.connection Insufficient arguments.<br>		
	Usage: device.connection vmid deviceKey connect Connect/Disconnect the virtual device specified <br>		
	~ # vim-cmd vmsvc/device.connection 16 4000 1 <br>		
	# vim-cmd vmsvc/get.summary 16 | grep ipAddress <br>		
	ipAddress = "192.168.1.56",		
	</div>		
	</p>				
	
	<h4>2.2.3 VM autostart <span class="badge badge-secondary">5 minutes</span></h4>

	<p> The configuration values for VM automatic startup and shutdown is stored in the file /etc/vmware/hostd/vmAutoStart.xml. By default auto start is not enabled. 
	Change it !		
	</p>
	
	
	 </div>
  
  
<div class="alert alert-warning">
      <h4 class="alert alert-warning">Finish !</h4>
</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/components/prism-core.min.js" integrity="sha256-Y+Budm2wBEjYjbH0qcJRmLuRBFpXd0VKxl6XhdS4hgA=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js" integrity="sha256-ht8ay6ZTPZfuixYB99I5oRpCLsCq7Do2LjEYLwbe+X8=" crossorigin="anonymous"></script>
</body>
</html>


